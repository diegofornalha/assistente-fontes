<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projetos - Claude Sessions</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/summary-modal.css">
    <script>
        document.documentElement.dataset.theme = 'light';
    </script>
</head>
<body>
    <div class="container">
        <!-- Toolbar com bot√£o Chat sempre vis√≠vel -->
        <div class="chat-toolbar" style="margin-bottom: 1rem;">
            <div class="toolbar-left">
                <!-- Espa√ßo vazio para manter layout -->
            </div>
            <div class="toolbar-right">
                <a href="index.html" class="toolbar-link" title="Ir para o chat" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                    <span>üí¨</span>
                    <span>Chat</span>
                </a>
            </div>
        </div>

        <div class="chat-container">
            <div id="sessions-list" class="messages sessions-list"></div>
        </div>
    </div>

    <script>
        window.addEventListener('load', async () => {
            const container = document.getElementById('sessions-list');

            function getUserLabelOverride(sessionId) {
                if (!sessionId) return '';
                try {
                    return (localStorage.getItem(`session_label:${sessionId}`) || '').trim();
                } catch (e) {
                    return '';
                }
            }

            function setUserLabelOverride(sessionId, label) {
                if (!sessionId) return;
                try {
                    const value = (label || '').trim();
                    if (!value) {
                        localStorage.removeItem(`session_label:${sessionId}`);
                    } else {
                        localStorage.setItem(`session_label:${sessionId}`, value.slice(0, 80));
                    }
                } catch (e) {}
            }

            function renderModelLine(session) {
                const base = `ü§ñ ${session.model || 'Modelo'}`;
                const override = getUserLabelOverride(session.session_id);
                const inferred = (session.label || '').trim();
                const label = override || inferred;
                return label ? `${base} / ${label}` : base;
            }

            try {
                const response = await fetch(`${window.location.origin}/sessions`);
                const data = await response.json();

                if (data.sessions.length === 0) {
                    container.innerHTML = '<p class="empty-state">Nenhuma sess√£o encontrada</p>';
                    return;
                }

                // Detectar √∫ltima sess√£o acessada via localStorage ou documento.referrer
                const lastSessionId = localStorage.getItem('last_session_id');

                data.sessions.forEach((session, index) => {
                    const card = document.createElement('div');
                    card.className = 'session-card';
                    card.dataset.sessionId = session.session_id;

                    // Marcar sess√£o mais recente como ativa
                    const isActive = index === 0;
                    if (isActive) {
                        card.classList.add('active-session');
                    }

                    const filePath = (session.file || '').replace(/\\/g, '/');
                    const projectFolder = filePath.split('/').slice(-2, -1)[0] || 'Projeto desconhecido';
                    const updated = new Date(session.updated_at).toLocaleString('pt-BR');

                    const activeBadge = isActive ? '<span class="active-badge">‚ú® Atual</span>' : '';

                    // Exibir t√≠tulo e resumo se existirem
                    const titleDisplay = session.title ? `<div class="session-title-display">${session.title}</div>` : '';
                    const summaryDisplay = session.summary ? `
                        <div class="session-summary-preview">
                            <div class="preview-text">${session.summary}</div>
                        </div>
                    ` : '<div class="session-summary-preview empty"></div>';

                    card.innerHTML = `
                        <div class="session-card-header session-header">
                            <div>
                                <h3>üóÇÔ∏è ${projectFolder}</h3>
                                <p class="session-card-subtitle">${session.file_name}</p>
                                ${titleDisplay}
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${activeBadge}
                                <span class="session-card-badge">${session.message_count} mensagens</span>
                                <button class="rename-session-btn" data-session-id="${session.session_id}" title="Gerenciar sess√£o (t√≠tulo e resumo)" style="pointer-events: auto; position: relative; z-index: 10; cursor: pointer;">‚ú®</button>
                                <button class="delete-session-btn" data-session-id="${session.session_id}" title="Deletar sess√£o" style="pointer-events: auto; position: relative; z-index: 10; cursor: pointer;">üóëÔ∏è</button>
                            </div>
                        </div>
                        ${summaryDisplay}
                        <div class="session-card-meta">
                            <div class="session-model-line">${renderModelLine(session)}</div>
                            <div class="session-card-date">üìÖ ${updated}</div>
                        </div>
                    `;

                    card.onclick = (e) => {
                        // N√£o navega se clicou em bot√µes ou seus filhos
                        if (e.target.closest('.delete-session-btn') || 
                            e.target.closest('.rename-session-btn') ||
                            e.target.classList.contains('delete-session-btn') ||
                            e.target.classList.contains('rename-session-btn')) {
                            return;
                        }
                        window.location.href = 'session-viewer.html?session_id=' + session.session_id;
                    };

                    const deleteBtn = card.querySelector('.delete-session-btn');
                    if (deleteBtn) {
                        // Garante que o bot√£o seja clic√°vel
                        deleteBtn.style.pointerEvents = 'auto';
                        deleteBtn.style.position = 'relative';
                        deleteBtn.style.zIndex = '10';
                        deleteBtn.style.cursor = 'pointer';
                        
                        deleteBtn.onclick = async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Confirma√ß√£o antes de deletar
                            const confirmMessage = `Tem certeza que deseja deletar a sess√£o "${session.file_name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`;
                            if (!confirm(confirmMessage)) {
                                return;
                            }

                            // Desabilita o bot√£o durante a opera√ß√£o
                            deleteBtn.disabled = true;
                            deleteBtn.textContent = '‚è≥';
                            deleteBtn.style.opacity = '0.5';
                            deleteBtn.style.cursor = 'not-allowed';

                            try {
                                const sessionId = session.session_id;
                                if (!sessionId) {
                                    throw new Error('Session ID n√£o encontrado');
                                }

                                const url = `${window.location.origin}/sessions/${encodeURIComponent(sessionId)}`;

                                const response = await fetch(url, { 
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });

                                if (!response.ok) {
                                    const errorText = await response.text();
                                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                                }

                                const result = await response.json();

                                if (result.success) {
                                    const action = result.action || 'deleted';
                                    
                                    // Adiciona anima√ß√£o de remo√ß√£o
                                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                                    card.style.opacity = '0';
                                    card.style.transform = 'scale(0.9)';
                                    
                                    setTimeout(() => {
                                        card.remove();
                                    }, 300);
                                } else {
                                    throw new Error(result.error || 'Falha desconhecida ao deletar');
                                }
                            } catch (error) {
                                console.error('Erro ao deletar sess√£o:', error);
                                alert(`Erro ao deletar sess√£o:\n${error.message}`);
                                
                                // Restaura o bot√£o
                                deleteBtn.disabled = false;
                                deleteBtn.textContent = 'üóëÔ∏è';
                                deleteBtn.style.opacity = '1';
                                deleteBtn.style.cursor = 'pointer';
                            }
                        };
                    }

                    const renameBtn = card.querySelector('.rename-session-btn');
                    if (renameBtn) {
                        renameBtn.onclick = async (e) => {
                            e.stopPropagation();

                            // Aguardar o SessionManager ser inicializado
                            if (!window.sessionManager) {
                                // Aguardar um pouco e tentar novamente
                                await new Promise(resolve => setTimeout(resolve, 100));
                                if (!window.sessionManager) {
                                    alert('Carregando gerenciador de sess√µes...');
                                    return;
                                }
                            }

                            // Carregar metadados atuais
                            const metadata = await window.sessionManager.loadSessionMetadata(session.session_id);

                            // Abrir modal com metadados carregados
                            window.sessionManager.openModal(
                                session.session_id,
                                metadata?.title || '',
                                metadata?.summary || ''
                            );
                        };
                    }

                    container.appendChild(card);
                });

            } catch (error) {
                console.error('Erro:', error);
                container.innerHTML = '<p class="empty-state error">‚ùå Erro ao carregar sess√µes</p>';
            }
        });
    </script>

    <script src="../js/session-manager.js"></script>
</body>
</html>
