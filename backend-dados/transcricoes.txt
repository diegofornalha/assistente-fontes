
);
```

---

## 3) DATA LAKE ‚Äî SILVER (LEAD √öNICO + EVENTOS)

### 3.1 `silver_leads`

```sql
create table silver_leads (
  lead_id uuid primary key default uuid_generate_v4(),
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),

  full_name text,
  first_name text,
  email text,
  phone_e164 text,
  whatsapp_e164 text,

  profession text,
  specialty text,
  city text,
  state text,
  country text default 'BR',

  instagram_handle text,
  source_first_touch text,

  consent_call_recording boolean default false,
  consent_at timestamptz,

  dedup_key text, -- hash email/phone
  data_quality_score numeric(3,2) default 0.50
);
```

---

### 3.2 `silver_lead_diagnosis_initial`

```sql
create table silver_lead_diagnosis_initial (
  diagnosis_id uuid primary key default uuid_generate_v4(),
  lead_id uuid references silver_leads(lead_id) on delete cascade,

  submitted_at timestamptz default now(),

  pain_primary text,
  stage text,
  objectives jsonb,
  barriers jsonb,
  urgency_level text,
  desired_patient_profile text,
  marketing_experience text
);
```

---

### 3.3 `silver_lead_enrichment`

```sql
create table silver_lead_enrichment (
  enrichment_id uuid primary key default uuid_generate_v4(),
  lead_id uuid references silver_leads(lead_id) on delete cascade,

  created_at timestamptz default now(),
  method text, -- manual_ai | semi_auto | auto

  queries_used jsonb,
  found_instagram boolean,
  clinic_name text,
  clinic_site text,
  public_profiles jsonb,

  confidence numeric(3,2),
  notes text
);
```

---

### 3.4 `silver_calls`

```sql
create table silver_calls (
  call_id uuid primary key default uuid_generate_v4(),
  lead_id uuid references silver_leads(lead_id) on delete set null,

  meeting_id text,
  call_type call_type,
  call_status call_status,

  scheduled_at timestamptz,
  started_at timestamptz,
  ended_at timestamptz,
  duration_seconds integer,

  owner_user_id uuid,
  recording_uri text
);
```

---

### 3.5 `silver_call_transcripts`

```sql
create table silver_call_transcripts (
  transcript_id uuid primary key default uuid_generate_v4(),
  call_id uuid references silver_calls(call_id) on delete cascade,
  lead_id uuid references silver_leads(lead_id) on delete cascade,

  transcribed_at timestamptz default now(),
  language text default 'pt-BR',
  transcript_text text,
  segments jsonb,
  quality numeric(3,2)
);
```

---

### 3.6 `silver_lead_events` ‚≠ê (core do sistema)

```sql
create table silver_lead_events (
  event_id uuid primary key default uuid_generate_v4(),
  lead_id uuid references silver_leads(lead_id) on delete cascade,

  event_at timestamptz default now(),
  event_type text,
  actor_type text, -- system | ai | human | lead
  actor_id uuid,

  channel text,
  payload jsonb,

  related_call_id uuid,
  related_order_id uuid
);
```

---

## 4) DATA LAKE ‚Äî GOLD (INTELIG√äNCIA)

### 4.1 `gold_lead_scoring`

```sql
create table gold_lead_scoring (
  lead_id uuid primary key references silver_leads(lead_id) on delete cascade,

  scored_at timestamptz default now(),
  lead_score integer,
  temperature lead_temperature,
  buy_probability numeric(4,3),
  urgency_score integer,
  data_quality_score numeric(3,2),

  explanations jsonb
);
```

---

### 4.2 `gold_lead_clustering`

```sql
create table gold_lead_clustering (
  lead_id uuid primary key references silver_leads(lead_id) on delete cascade,

  clustered_at timestamptz default now(),
  cluster_id text,
  persona_id text,
  persona_summary text,

  pain_bucket text,
  stage_bucket text,
  confidence numeric(3,2)
);
```

---

### 4.3 `gold_call_intelligence`

```sql
create table gold_call_intelligence (
  call_id uuid primary key references silver_calls(call_id) on delete cascade,
  lead_id uuid references silver_leads(lead_id) on delete cascade,

  analyzed_at timestamptz default now(),
  objections jsonb,
  explicit_pains jsonb,
  implicit_pains jsonb,
  buy_signals jsonb,
  risk_flags jsonb,

  estimated_budget numeric,
  next_best_action text,
  score_delta integer,
  cluster_delta text
);
```

---

## 5) CRM OPERACIONAL

### 5.1 `crm_lead_state`

```sql
create table crm_lead_state (
  lead_id uuid primary key references silver_leads(lead_id) on delete cascade,

  current_state lead_state not null,
  state_updated_at timestamptz default now(),

  owner_team text,
  owner_user_id uuid,
  sla_due_at timestamptz,
  notes text
);
```

---

### 5.2 `crm_tasks`

```sql
create table crm_tasks (
  task_id uuid primary key default uuid_generate_v4(),
  lead_id uuid references silver_leads(lead_id) on delete cascade,

  created_at timestamptz default now(),
  due_at timestamptz,

  task_type task_type,
  priority task_priority,
  status text default 'open',

  assigned_to_user_id uuid,
  ai_recommendation text,
  evidence jsonb
);
```

---

### 5.3 `crm_meetings`

```sql
create table crm_meetings (
  meeting_id text primary key,
  lead_id uuid references silver_leads(lead_id) on delete cascade,

  meeting_type call_type,
  created_by text, -- ai | human
  created_at timestamptz default now(),
  scheduled_at timestamptz,
  timezone text,

  status call_status,
  google_calendar_event_id text,
  google_meet_url text,
  recording_expected boolean default true
);
```

---

### 5.4 `crm_products`

```sql
create table crm_products (
  product_id uuid primary key default uuid_generate_v4(),
  name text not null,
  type product_type,
  price numeric,
  currency text default 'BRL',
  active boolean default true
);
```

---

### 5.5 `crm_orders`

```sql
create table crm_orders (
  order_id uuid primary key default uuid_generate_v4(),
  lead_id uuid references silver_leads(lead_id) on delete cascade,
  product_id uuid references crm_products(product_id),

  sold_at timestamptz default now(),
  status order_status,
  amount numeric,
  seller_user_id uuid,

  payment_method text,
  loss_reason text,
  notes text
);
```

---

### 5.6 `crm_relationship_followups`

```sql
create table crm_relationship_followups (
  followup_id uuid primary key default uuid_generate_v4(),
  lead_id uuid references silver_leads(lead_id) on delete cascade,
  order_id uuid references crm_orders(order_id),

  scheduled_at timestamptz,
  purpose text,
  status text,

  owner_user_id uuid,
  outcome_notes text
);
```

---

## 6) √çNDICES ESSENCIAIS (performance)

```sql
-- Deduplica√ß√£o
create index idx_leads_dedup on silver_leads(dedup_key);

-- Busca r√°pida
create index idx_leads_email on silver_leads(email);
create index idx_leads_phone on silver_leads(phone_e164);

-- Eventos
create index idx_events_lead_time on silver_lead_events(lead_id, event_at desc);

-- Score / Cluster
create index idx_gold_score on gold_lead_scoring(lead_score desc);
create index idx_gold_cluster on gold_lead_clustering(cluster_id);

-- Agenda
create index idx_meetings_schedule on crm_meetings(scheduled_at);
```

---

## 7) Observa√ß√µes IMPORTANTES para Supabase (RLS)

**Recomenda√ß√£o:**

* Ativar RLS em todas as tabelas
* Criar policies por `owner_team` e `owner_user_id`
* Separar:

  * acesso vendas
  * acesso Fernanda
  * acesso gest√£o
  * acesso sistema/IA

> Se quiser, eu te entrego **as RLS Policies prontas** (copiar/colar).

---

## Conclus√£o

Voc√™ agora tem:

* ‚úîÔ∏è Modelo de dados enterprise
* ‚úîÔ∏è Compat√≠vel com Supabase
* ‚úîÔ∏è Pronto para MVP e escala
* ‚úîÔ∏è Preparado para CRM inteligente de verdade
* ‚úîÔ∏è Perfeito para auditoria, IA e gest√£o

### Pr√≥ximo passo l√≥gico

Quer que eu gere agora:

4Ô∏è‚É£ **RLS Policies (Supabase)**
5Ô∏è‚É£ **Fun√ß√µes SQL (ex: atualizar estado, registrar evento)**
6Ô∏è‚É£ **Triggers (ex: call ‚Üí atualizar score/cluster)**

üëâ Me diga o n√∫mero e sigo imediatamente.
[17/12/2025, 17:43:20] Luiz NANDA MAC: Perfeito.
Abaixo est√£o as **RLS POLICIES COMPLETAS PARA SUPABASE / POSTGRES**, **prontas para copiar e colar**, alinhadas com:

* CRM Inteligente
* Times (Fernanda, Vendas, Gest√£o)
* IA (service role)
* LGPD / m√≠nimo acesso necess√°rio
* Escalabilidade futura

itual**: s√≥üëâ **Nada conce o que funciona na pr√°tica.

---

# üîê RLS ‚Äî POLICIES OFICIAIS (SUPABASE)

## PRINC√çPIOS DE SEGURAN√áA ADOTADOS

1. **Default deny**: ningu√©m v√™ nada sem policy
2. **Acesso por papel (role)**
3. **IA usa service_role (bypass RLS)**
4. **Humano v√™ s√≥ o que precisa**
5. **Gest√£o v√™ tudo**

---

## 0Ô∏è‚É£ PR√â-REQUISITO ‚Äî TABELA DE PERFIS

Crie uma tabela simples para mapear usu√°rios:

```sql
create table user_profiles (
  user_id uuid primary key references auth.users(id) on delete cascade,
  role text not null, -- 'fernanda', 'vendas', 'gestao'
  created_at timestamptz default now()
);
```

---

## 1Ô∏è‚É£ ATIVAR RLS (OBRIGAT√ìRIO)

Execute para **todas as tabelas sens√≠veis**:

```sql
alter table silver_leads enable row level security;
alter table silver_lead_diagnosis_initial enable row level security;
alter table silver_lead_enrichment enable row level security;
alter table silver_calls enable row level security;
alter table silver_call_transcripts enable row level security;
alter table silver_lead_events enable row level security;

alter table gold_lead_scoring enable row level security;
alter table gold_lead_clustering enable row level security;
alter table gold_call_intelligence enable row level security;

alter table crm_lead_state enable row level security;
alter table crm_tasks enable row level security;
alter table crm_meetings enable row level security;
alter table crm_orders enable row level security;
alter table crm_relationship_followups enable row level security;
```

---

## 2Ô∏è‚É£ FUN√á√ÉO AUXILIAR ‚Äî PAPEL DO USU√ÅRIO

Centraliza a checagem de papel:

```sql
create or replace function public.current_user_role()
returns text
language sql
stable
as $
  select role
  from user_profiles
  where user_id = auth.uid();
$;
```

---

## 3Ô∏è‚É£ POLICIES ‚Äî SILVER (LEADS E EVENTOS)

### 3.1 `silver_leads`

#### SELECT

```sql
create policy "select_leads_by_role"
on silver_leads
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);
```

#### INSERT (somente sistema / IA)

```sql
create policy "insert_leads_system_only"
on silver_leads
for insert
with check (
  auth.role() = 'service_role'
);
```

#### UPDATE

```sql
create policy "update_leads_limited"
on silver_leads
for update
using (
  current_user_role() in ('fernanda','vendas','gestao')
);
```

---

### 3.2 `silver_lead_events` (AUDITORIA ‚Äî N√ÉO APAGA)

```sql
create policy "select_events_by_role"
on silver_lead_events
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "insert_events_system"
on silver_lead_events
for insert
with check (
  auth.role() = 'service_role'
);
```

‚ùå **Sem UPDATE / DELETE** (imut√°vel)

---

## 4Ô∏è‚É£ POLICIES ‚Äî CALLS & TRANSCRI√á√ïES

### 4.1 `silver_calls`

```sql
create policy "select_calls_by_role"
on silver_calls
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "insert_calls_system"
on silver_calls
for insert
with check (
  auth.role() = 'service_role'
);
```

---

### 4.2 `silver_call_transcripts`

```sql
create policy "select_transcripts_by_role"
on silver_call_transcripts
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "insert_transcripts_system"
on silver_call_transcripts
for insert
with check (
  auth.role() = 'service_role'
);
```

üìå **Equipe nunca grava transcri√ß√£o manualmente**.

---

## 5Ô∏è‚É£ POLICIES ‚Äî GOLD (INTELIG√äNCIA)

### 5.1 `gold_lead_scoring`

```sql
create policy "select_scoring_by_role"
on gold_lead_scoring
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "write_scoring_system"
on gold_lead_scoring
for all
using (
  auth.role() = 'service_role'
)
with check (
  auth.role() = 'service_role'
);
```

---

### 5.2 `gold_lead_clustering`

```sql
create policy "select_clustering_by_role"
on gold_lead_clustering
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "write_clustering_system"
on gold_lead_clustering
for all
using (
  auth.role() = 'service_role'
)
with check (
  auth.role() = 'service_role'
);
```

---

### 5.3 `gold_call_intelligence`

```sql
create policy "select_call_intelligence_by_role"
on gold_call_intelligence
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "write_call_intelligence_system"
on gold_call_intelligence
for all
using (
  auth.role() = 'service_role'
)
with check (
  auth.role() = 'service_role'
);
```

---

## 6Ô∏è‚É£ POLICIES ‚Äî CRM OPERACIONAL

### 6.1 `crm_lead_state`

```sql
create policy "select_lead_state_by_role"
on crm_lead_state
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "update_lead_state_by_role"
on crm_lead_state
for update
using (
  current_user_role() in ('fernanda','vendas','gestao')
);
```

---

### 6.2 `crm_tasks`

```sql
create policy "select_tasks_by_role"
on crm_tasks
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "update_tasks_owner"
on crm_tasks
for update
using (
  assigned_to_user_id = auth.uid()
  or current_user_role() = 'gestao'
);
```

---

### 6.3 `crm_meetings`

```sql
create policy "select_meetings_by_role"
on crm_meetings
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "write_meetings_system"
on crm_meetings
for all
using (
  auth.role() = 'service_role'
)
with check (
  auth.role() = 'service_role'
);
```

---

### 6.4 `crm_orders`

```sql
create policy "select_orders_by_role"
on crm_orders
for select
using (
  current_user_role() in ('fernanda','vendas','gestao')
);

create policy "insert_orders_sales"
on crm_orders
for insert
with check (
  current_user_role() in ('vendas','gestao')
);
```

---

### 6.5 `crm_relationship_followups`

```sql
create policy "select_followups_by_role"
on crm_relationship_followups
for select
using (
  current_user_role() in ('vendas','gestao')
);

create policy "write_followups_sales"
on crm_relationship_followups
for all
using (
  current_user_role() in ('vendas','gestao')
)
with check (
  current_user_role() in ('vendas','gestao')
);
```

---

## 7Ô∏è‚É£ O PAPEL DA IA (IMPORTANTE)

* A **IA roda com `service_role`**
* **Bypassa RLS**
* Cria:

  * leads
  * eventos
  * scoring
  * clustering
  * transcri√ß√µes
  * intelig√™ncia
  * reuni√µes

üëâ Humanos **nunca** escrevem no Gold.

---

## 8Ô∏è‚É£ RESUMO EXECUTIVO (PARA DOCUMENTO)

‚úîÔ∏è Seguran√ßa por design
‚úîÔ∏è LGPD-friendly
‚úîÔ∏è Acesso m√≠nimo necess√°rio
‚úîÔ∏è Auditoria completa
‚úîÔ∏è Escala sem risco
‚úîÔ∏è IA como "funcion√°rio do sistema"

---

## Pr√≥ximo passo (se quiser continuar)

Posso gerar agora:

5Ô∏è‚É£ **Fun√ß√µes SQL transacionais** (ex: mudar estado do lead + logar evento)
6Ô∏è‚É£ **Triggers autom√°ticos** (ex: call conclu√≠da ‚Üí atualizar score/cluster)
7Ô∏è‚É£ **Diagrama RLS + pap√©is (visual para jur√≠dico)**

üëâ √â s√≥ me dizer o n√∫mero.
[17/12/2025, 17:44:47] Luiz NANDA MAC: Perfeito.
Abaixo est√£o as **FUN√á√ïES SQL TRANSACIONAIS (Postgres / Supabase)** ‚Äî **prontas para copiar e colar** ‚Äî que **fazem o CRM funcionar de verdade**, garantindo:

* **atomicidade** (ou tudo acontece, ou nada)
* **auditoria autom√°tica** (`silver_lead_events`)
* **estado √∫nico do lead**
* **integra√ß√£o com score/cluster**
* **base limpa para IA operar**

üëâ Estas fun√ß√µes s√£o o **cora√ß√£o operacional** do CRM Inteligente.

---

# ‚öôÔ∏è FUN√á√ïES SQL ‚Äî CRM INTELIGENTE (SUPABASE)

## PRINC√çPIO DE DESIGN

Toda a√ß√£o relevante:

1. **Atualiza o estado do lead**
2. **Registra um evento**
3. **Mant√©m hist√≥rico imut√°vel**
4. **Pode ser chamada pela IA ou pelo backend**

---

## 1Ô∏è‚É£ Fun√ß√£o base ‚Äî Registrar EVENTO do lead

> Use em TODAS as outras fun√ß√µes.

```sql
create or replace function log_lead_event(
  p_lead_id uuid,
  p_event_type text,
  p_actor_type text,
  p_actor_id uuid,
  p_channel text,
  p_payload jsonb default '{}'::jsonb,
  p_related_call_id uuid default null,
  p_related_order_id uuid default null
) returns void
language plpgsql
security definer
as $
begin
  insert into silver_lead_events (
    lead_id,
    event_at,
    event_type,
    actor_type,
    actor_id,
    channel,
    payload,
    related_call_id,
    related_order_id
  )
  values (
    p_lead_id,
    now(),
    p_event_type,
    p_actor_type,
    p_actor_id,
    p_channel,
    p_payload,
    p_related_call_id,
    p_related_order_id
  );
end;
$;
```

---

## 2Ô∏è‚É£ Atualizar ESTADO do lead (com auditoria)

> Fun√ß√£o MAIS importante do CRM.

```sql
create or replace function update_lead_state(
  p_lead_id uuid,
  p_new_state lead_state,
  p_actor_type text,
  p_actor_id uuid,
  p_notes text default null
) returns void
language plpgsql
security definer
as $
begin
  update crm_lead_state
  set
    current_state = p_new_state,
    state_updated_at = now(),
    notes = p_notes
  where lead_id = p_lead_id;

  perform log_lead_event(
    p_lead_id,
    'state_changed',
    p_actor_type,
    p_actor_id,
    'crm',
    jsonb_build_object(
      'new_state', p_new_state,
      'notes', p_notes
    )
  );
end;
$;
```

---

## 3Ô∏è‚É£ Criar LEAD + estado inicial (LP / Typeform)

```sql
create or replace function create_lead_with_state(
  p_full_name text,
  p_email text,
  p_phone text,
  p_profession text,
  p_source text
) returns uuid
language plpgsql
security definer
as $
declare
  v_lead_id uuid;
begin
  insert into silver_leads (
    full_name,
    first_name,
    email,
    phone_e164,
    profession,
    source_first_touch
  )
  values (
    p_full_name,
    split_part(p_full_name, ' ', 1),
    p_email,
    p_phone,
    p_profession,
    p_source
  )
  returning lead_id into v_lead_id;

  insert into crm_lead_state (
    lead_id,
    current_state,
    owner_team
  )
  values (
    v_lead_id,
    'novo',
    'marketing'
  );

  perform log_lead_event(
    v_lead_id,
    'lead_captured',
    'system',
    null,
    'landing_page',
    jsonb_build_object(
      'source', p_source
    )
  );

  return v_lead_id;
end;
$;
```

---

## 4Ô∏è‚É£ Agendar DIAGN√ìSTICO (IA controla agenda)

```sql
create or replace function schedule_diagnostic_meeting(
  p_lead_id uuid,
  p_meeting_id text,
  p_scheduled_at timestamptz,
  p_created_by text -- ai | human
) returns void
language plpgsql
security definer
as $
begin
  insert into crm_meetings (
    meeting_id,
    lead_id,
    meeting_type,
    created_by,
    scheduled_at,
    status
  )
  values (
    p_meeting_id,
    p_lead_id,
    'diagnostico',
    p_created_by,
    p_scheduled_at,
    'scheduled'
  );

  perform update_lead_state(
    p_lead_id,
    'diagnostico_agendado',
    'ai',
    null,
    'Diagn√≥stico agendado'
  );

  perform log_lead_event(
    p_lead_id,
    'diagnostic_scheduled',
    'ai',
    null,
    'agenda',
    jsonb_build_object(
      'meeting_id', p_meeting_id,
      'scheduled_at', p_scheduled_at
    )
  );
end;
$;
```

---

## 5Ô∏è‚É£ Registrar CALL conclu√≠da (gatilho de intelig√™ncia)

```sql
create or replace function register_call_done(
  p_call_id uuid,
  p_lead_id uuid,
  p_duration_seconds integer,
  p_owner_user_id uuid
) returns void
language plpgsql
security definer
as $
begin
  update silver_calls
  set
    call_status = 'done',
    duration_seconds = p_duration_seconds,
    ended_at = now()
  where call_id = p_call_id;

  perform log_lead_event(
    p_lead_id,
    'call_completed',
    'human',
    p_owner_user_id,
    'meet',
    jsonb_build_object(
      'duration_seconds', p_duration_seconds
    ),
    p_call_id
  );
end;
$;
```

---

## 6Ô∏è‚É£ Registrar PRODUTO VENDIDO (multi-produto)

```sql
create or replace function register_product_sale(
  p_lead_id uuid,
  p_product_id uuid,
  p_amount numeric,
  p_seller_user_id uuid
) returns uuid
language plpgsql
security definer
as $
declare
  v_order_id uuid;
begin
  insert into crm_orders (
    lead_id,
    product_id,
    amount,
    status,
    seller_user_id
  )
  values (
    p_lead_id,
    p_product_id,
    p_amount,
    'won',
    p_seller_user_id
  )
  returning order_id into v_order_id;

  perform update_lead_state(
    p_lead_id,
    'produto_vendido',
    'human',
    p_seller_user_id,
    'Produto vendido'
  );

  perform log_lead_event(
    p_lead_id,
    'product_sold',
    'human',
    p_seller_user_id,
    'crm',
    jsonb_build_object(
      'product_id', p_product_id,
      'amount', p_amount
    ),
    null,
    v_order_id
  );

  return v_order_id;
end;
$;
```

---

## 7Ô∏è‚É£ Registrar PERDA com motivo (obrigat√≥rio)

```sql
create or replace function register_lead_lost(
  p_lead_id uuid,
  p_loss_reason text,
  p_actor_user_id uuid
) returns void
language plpgsql
security definer
as $
begin
  perform update_lead_state(
    p_lead_id,
    'perdido_com_motivo',
    'human',
    p_actor_user_id,
    p_loss_reason
  );

  perform log_lead_event(
    p_lead_id,
    'lead_lost',
    'human',
    p_actor_user_id,
    'crm',
    jsonb_build_object(
      'reason', p_loss_reason
    )
  );
end;
$;
```

---

## 8Ô∏è‚É£ Agendar FOLLOW-UP de relacionamento

```sql
create or replace function schedule_relationship_followup(
  p_lead_id uuid,
  p_order_id uuid,
  p_scheduled_at timestamptz,
  p_owner_user_id uuid,
  p_purpose text
) returns void
language plpgsql
security definer
as $
begin
  insert into crm_relationship_followups (
    lead_id,
    order_id,
    scheduled_at,
    purpose,
    status,
    owner_user_id
  )
  values (
    p_lead_id,
    p_order_id,
    p_scheduled_at,
    p_purpose,
    'scheduled',
    p_owner_user_id
  );

  perform update_lead_state(
    p_lead_id,
    'followup_rel 'human',
    p_owner_user_idacionamento',
   ,
    'Follow-up de relacionamento agendado'
  );

  perform log_lead_event(
    p_lead_id,
    'followup_scheduled',
    'human',
    p_owner_user_id,
    'crm',
    jsonb_build_object(
      'purpose', p_purpose,
      'scheduled_at', p_scheduled_at
    )
  );
end;
$;
```

---

## 9Ô∏è‚É£ Como a IA usa isso (resumo)

A IA **N√ÉO escreve SQL direto**.
Ela chama:

* `create_lead_with_state()`
* `schedule_diagnostic_meeting()`
* `register_call_done()`
* `register_product_sale()`
* `register_lead_lost()`
* `schedule_relationship_followup()`

üëâ Cada chamada:

* muda estado
* registra evento
* mant√©m trilha audit√°vel
* alimenta o Data Lake

---

## üîí Seguran√ßa

* Todas as fun√ß√µes s√£o `SECURITY DEFINER`
* Chamadas pelo backend com **service_role**
* Humanos s√≥ disparam a√ß√µes via API (n√£o direto no banco)

---

## CONCLUS√ÉO

Agora voc√™ tem:

‚úîÔ∏è CRM realmente transacional
‚úîÔ∏è Auditoria nativa
‚úîÔ∏è Estado √∫nico do lead
‚úîÔ∏è Base perfeita para IA
‚úîÔ∏è Zero risco de inconsist√™ncia

---

### Pr√≥ximo passo l√≥gico

Quer que eu entregue agora:

6Ô∏è‚É£ **TRIGGERS AUTOM√ÅTICOS**
(ex: call finalizada ‚Üí atualizar score/cluster automaticamente)

7Ô∏è‚É£ **DIAGRAMA VISUAL** dessas fun√ß√µes no fluxo

üëâ Diga **6** ou **7**.
